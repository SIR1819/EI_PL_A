<!DOCTYPE html>
<html>
    <head>
        <title>Euromilhões</title>
        <meta charset="utf-8"/>
        <link rel="stylesheet" href="chave.css"/>
    </head>
    <body>
        <h1>Euromilhões</h1>
        <div>
            <button id="bgera">Gera Chave</button>
            <button id="bobter">Obter Chave</button>
            <button id="bobter2">Obter -Fetch- Chave</button>
            <button id="blimpa">Limpar Chaves</button>
        </div>
        
        <div id="chaves">
        <!--div>
        <ul class="estrelas">
            <li>5</li>
            <li>11</li>
        </ul>
        <ul class="numeros">
            <li>2</li>
            <li>9</li>
            <li>34</li>
            <li>45</li>
            <li>47</li>
        </ul>
        </div-->
        </div>
    </body>
    <script>

        myB = document.getElementById("bgera");
        myB.onclick = geraChave;

        myObter = document.getElementById("bobter");
        myObter.addEventListener("click", obterChave);

        myObter2 = document.getElementById("bobter2");
        myObter2.addEventListener("click", obterChave2);

        myLimpa = document.getElementById("blimpa");
        myLimpa.addEventListener("click", limpaChaves);

        geraChave();  // gerar uma chave por defeito

        function limpaChaves() {
            divChaves = document.getElementById("chaves");
            divChaves.innerHTML="";
        }

        function obterChave2() {
            fetch('http://localhost/SIR1819/EI_PL_A/EUROMILHOES/gerador.php')
                .then(function(response) {
                    return response.json;
                })
                .then(function(myJson) {
                    console.log(myJson);
                    console.log(JSON.stringify(myJson));
                });
        }

        function obterChave() {

            aReq = new XMLHttpRequest();
            //aReq.onreadystatechange = function () {
            aReq.onload = function () {
                console.log(this.readyState, this.status);
                //if (this.readyState == 4 && this.status == 200) {
                        console.log(this.responseText);
                        console.log(this.responseXML);
                        myChave = JSON.parse(this.responseText);
                        console.log(myChave);
                        afixaChave(myChave);
                //}
            }
            aReq.open("GET","http://localhost/SIR1819/EI_PL_A/EUROMILHOES/gerador.php");

            aReq.send();
        }


        function afixaChave(chave) {
            newDIV = document.createElement("div");

            ULestrelas = array2HTMLList(chave.estrelas);
            ULestrelas.className = "estrelas";

            ULnumeros = array2HTMLList(chave.numeros);
            ULnumeros.className = "numeros";

            newDIV.appendChild(ULnumeros);
            newDIV.appendChild(ULestrelas);

            var divChaves = document.getElementById("chaves");
            divChaves.appendChild(newDIV);

            function array2HTMLList(arr) {
                var UL = document.createElement("ul");
                for(let i=0; i < arr.length; i++) {
                    newLI = document.createElement("li");
                    newLI.innerHTML = arr[i];
                    UL.appendChild(newLI)
                }
                return UL;
            }
        }


        function geraChave() {

        var chave = {
            "estrelas" : [],
            "numeros" : []
        };

        console.log(chave);

        function extract(min,max,num) {
            key = [];

            while(key.length < num) {
                let rnumber = min + Math.floor(Math.random() * (max - min + 1));
                //console.log(rnumber);
                if (key.indexOf(rnumber) == -1) {
                    key.push(rnumber);
                }
            }
            key.sort(function (a,b) {return (a-b);});
            console.log(key);
            return key;
        }
        
        //function compare(a,b) {
        //    return (a-b);
        //}

        chave.estrelas = extract(1,12,2);
        chave.numeros = extract(1,50,5);

        console.log(chave);

        afixaChave(chave);

        
        }


    </script>
</html>